---
title: "Make Plain Simulated Data for Smoking Visualisation"
author: "Rob Schick, PhD"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Make Plain Simulated Data for Smoking Visualisation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r global_options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, fig.height = 7, fig.width = 7)
```

Goal of this is to simply explore making some simulated data that we can visualise with a flexidashboard.

## Data Info

The idea is to take some various geocoded locations, and add them in to a data frame. These will be master ones to be recycled. These will contain a few candidate locations like: `home`, `work`, `grocery`, `pub1`, `pub2`, etc. This will just be a starting point.

```{r}
library(smokevis)
locs1
```

Those are the raw data, and we can visualise them as follows

```{r}
library(leaflet)
m <- leaflet(data = locs1) %>% setView(lng = -2.9, lat = 56.403, zoom = 11)
m %>% addTiles() %>% addMarkers(lng = locs1$lng, lat = locs1$lat, popup = locs1$location)
```

Next we might imagine that we want to separate out craving events with smoking events. That might look like this:

```{r}
pal <- colorFactor(c("navy", "red"), domain = c("crave", "smoke"))

locs1$type <- factor(
    ifelse(runif(nrow(locs1)) > 0.75, "crave", "smoke"),
    c("smoke", "crave"))

m %>% 
  addTiles() %>%
  addCircleMarkers(
  lng = ~lng, lat = ~lat, popup = ~location,
    radius = ~ifelse(locs1$type == "smoke", 6, 10),
    color = ~pal(locs1$type),
    stroke = FALSE, fillOpacity = 0.5
  )
```

Now just experimenting with some different functionality to toggle smoking events on and off:

```{r}
m %>% 
  addTiles() %>%
  addCircleMarkers(
    data = subset(locs1, type == 'smoke'),
  lng = ~lng, lat = ~lat, popup = ~location,
    radius = 10,
    color = 'red',
    stroke = FALSE, fillOpacity = 0.5,
  group = 'Smoking'
  ) %>%
  addCircleMarkers(
    data = subset(locs1, type != 'smoke'),
  lng = ~lng, lat = ~lat, popup = ~location,
    radius = 6,
    color = 'blue',
    stroke = FALSE, fillOpacity = 0.5,
  group = 'Craving'
  ) %>%
  # Layers control
  addLayersControl(
    overlayGroups = c("Smoking", "Craving"),
    options = layersControlOptions(collapsed = FALSE)
  )
```

## Mulitple Smoking Events
Ok, let's start building up a data frame of smoking events. I'm going to say this person is an average smoker smoking ~14 cigarettes per day (from this [2014 Scottish Health Survey](http://www.gov.scot/Publications/2015/09/6648/318764)). I'll simulate a standard week, comprised of 5 workdays, and 2 weekend days. 

Here are some simulated data:

```{r, simDat}
library(lubridate)
nweeks <- 1
nweekday <- nweeks * 5
nwkndday <- nweeks * 2

cigsweek    <- floor(rnorm(nweekday, 16, 3))
cigsweekend <- floor(rnorm(nwkndday, 12, 5))
dfNum <- data.frame(ncigs = c(cigsweekend[1], cigsweek, cigsweekend[2]),
                 dayofweek = wday(1:7, label = TRUE),
                 dayInt = wday(1:7),
                 date = seq.Date(as.Date('2016-06-19'), as.Date('2016-06-25'), by = 'day'))

smokeDat <- vector(mode = 'list', (nrow(dfNum)))

for(i in seq_along(lubridate::wday(1:(nweekday + nwkndday)))){
  
  ncigs <- dfNum$ncigs[i]
  dayVal <- dfNum$dayInt[i]
  dayLab <- dfNum$dayofweek[i]
  dayDate <- dfNum$date[i]
  idx <- sample(nrow(locs1), ncigs, replace = TRUE)
  
  dfDay <- data.frame(
    eventID = 1:ncigs,
    craving = tnorm(ncigs, lo = 0, hi = 10, mu = 7, sig = 3),
    satisfaction = tnorm(ncigs, lo = 0, hi = 10, mu = 6, sig = 3),
    taste = tnorm(ncigs, lo = 0, hi = 10, mu = 5, sig = 3),
    reduction = tnorm(ncigs, lo = 0, hi = 10, mu = 3, sig = 1),
    stress = ifelse(dayVal == 1 | dayVal == 7, 
                tnorm(ncigs, lo = 0, hi = 10, mu = 5, sig = 2), 
                tnorm(ncigs, lo = 0, hi = 10, mu = 7.5, sig = 3)),
    time = randTimes(ncigs, 
                     st = paste(dayDate, ' 06:30:00', sep = ''), 
                     et = paste(dayDate, ' 22:30:00', sep = '')),
    dayofweek = dayLab,
    lat = locs1$lat[idx],
    lng = locs1$lng[idx],
    qualLoc = locs1$location[idx],
    smoked = TRUE
  )  
  smokeDat[[i]] <- dfDay
}



```

